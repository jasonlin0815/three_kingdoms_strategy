# LINE Bot Integration - æ¥µç°¡è¨­è¨ˆ

> **Status**: Refactored to Minimalist Design
> **Date**: 2026-01-03
> **Last Updated**: 2026-01-03

---

## è¨­è¨ˆç†å¿µ

Bot åªåšå…©ä»¶äº‹ï¼š
1. **ç¾¤çµ„ç¶å®š** - æŠ€è¡“å¿…è¦ï¼Œç²å– `line_group_id`
2. **LIFF å…¥å£æ¨é€** - åœ¨é©ç•¶æ™‚æ©Ÿå¼•å°ç”¨æˆ¶é€²å…¥ LIFF

æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ LIFF Web UI å®Œæˆï¼ŒBot åªæ˜¯å…¥å£ã€‚

---

## è§¸ç™¼æ¢ä»¶

| è§¸ç™¼ | äº‹ä»¶ | å‹•ä½œ | é™åˆ¶ |
|------|------|------|------|
| Bot åŠ å…¥ç¾¤çµ„ | `join` | ç™¼é€ç¶å®šèªªæ˜ | - |
| æ–°æˆå“¡åŠ å…¥ | `memberJoined` | ç™¼é€ LIFF å…¥å£ (Flex) | ç¾¤çµ„å·²ç¶å®š |
| `/ç¶å®š CODE` | `message` | åŸ·è¡Œç¶å®š | - |
| @bot | `message` | ç™¼é€ LIFF å…¥å£ (Flex) | - |
| æœªè¨»å†Šè€…ç™¼è¨€ | `message` | ç™¼é€ LIFF å…¥å£ (Flex) | 3 åˆ†é˜ CD |
| ç”¨æˆ¶åŠ å¥½å‹ | `follow` | ç°¡çŸ­èªªæ˜ | - |

---

## è³‡æ–™è¡¨çµæ§‹

### line_user_notifications
è¨˜éŒ„å·²ç™¼é€é€šçŸ¥çš„ç”¨æˆ¶ï¼Œç¢ºä¿æ¯ç”¨æˆ¶æ¯ç¾¤çµ„åªé€šçŸ¥ä¸€æ¬¡ã€‚

```sql
CREATE TABLE line_user_notifications (
    line_group_id VARCHAR(64) NOT NULL,
    line_user_id VARCHAR(64) NOT NULL,
    sent_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY (line_group_id, line_user_id)
);
```

### å…¶ä»–è¡¨æ ¼ï¼ˆå·²å­˜åœ¨ï¼‰

- `line_binding_codes` - è‡¨æ™‚ç¶å®šç¢¼
- `line_group_bindings` - ç¾¤çµ„èˆ‡åŒç›Ÿå°æ‡‰
- `member_line_bindings` - æˆå“¡èˆ‡éŠæˆ² ID å°æ‡‰

---

## ç’°å¢ƒè®Šæ•¸

```env
# LINE Bot
LINE_CHANNEL_ID=xxxx
LINE_CHANNEL_SECRET=xxxx
LINE_ACCESS_TOKEN=xxxx
LINE_BOT_USER_ID=Uxxxx  # Bot çš„ user IDï¼Œç”¨æ–¼ @mention æª¢æ¸¬
LIFF_ID=xxxx-xxxx
```

### å¦‚ä½•ç²å– LINE_BOT_USER_ID

```bash
curl -H "Authorization: Bearer {ACCESS_TOKEN}" \
     https://api.line.me/v2/bot/info
```

å›æ‡‰ä¸­çš„ `userId` å³ç‚º Bot çš„ user IDã€‚

---

## è¨Šæ¯æ¨¡æ¿ï¼ˆç†±è¡€æˆ°å ´é¢¨ï¼‰

### 1. Bot åŠ å…¥ç¾¤çµ„
```
ğŸ‘‹ æˆ‘æ˜¯ä¸‰åœ‹å°å¹«æ‰‹ï¼

ğŸ“Œ é–‹å§‹ä½¿ç”¨ï¼š
ç›Ÿä¸»è«‹ç™¼é€ã€Œ/ç¶å®š XXXXXXã€å®Œæˆç¶å®š
ï¼ˆç¶å®šç¢¼è«‹åœ¨ Web App ç”Ÿæˆï¼‰
```

### 2. ç¶å®šæˆåŠŸï¼ˆFlex Messageï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ° åŒç›Ÿé€£çµæˆåŠŸï¼   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å„ä½ç›Ÿå‹ï¼Œ          â”‚
â”‚ é»æ“Šç™»è¨˜åè™Ÿï¼      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [ç«‹å³ç™»è¨˜]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. è¢« @ å›æ‡‰ï¼ˆFlex Messageï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš”ï¸ è»æƒ…é€Ÿå ±        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æˆ°ç¸¾ã€éŠ…ç¤¦ã€æ’å   â”‚
â”‚ ä¸€æ‰‹æŒæ¡           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [æŸ¥çœ‹è»æƒ…]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ–°æˆå“¡æ­¡è¿ï¼ˆFlex Messageï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¥ ç›Ÿå‹ä¾†äº†ï¼       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒç›Ÿæ­¡è¿ä½ ï¼Œ        â”‚
â”‚ é»æ“Šç¶å®šIDï¼        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [åŠ å…¥æˆ°é¬¥]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. é¦–æ¬¡ç™¼è¨€æé†’ï¼ˆFlex Messageï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¥ é‚„æ²’ç™»è¨˜ï¼Ÿ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»æ“Šä¸‹æ–¹ï¼Œ          â”‚
â”‚ å ±ååƒæˆ°ï¼          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [æˆ‘è¦åƒæˆ°]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
> æ³¨æ„ï¼š3 åˆ†é˜å…§ä¸é‡è¤‡ç™¼é€ï¼ˆCD æ©Ÿåˆ¶ï¼‰

### 6. ç§èŠå›è¦†
```
ğŸ’¡ è«‹åœ¨åŒç›Ÿç¾¤çµ„ä¸­ @æˆ‘ ä½¿ç”¨åŠŸèƒ½ï½
```

### 7. åŠ å¥½å‹å›è¦†
```
ğŸ‘‹ å—¨ï¼æˆ‘ä¸»è¦åœ¨ç¾¤çµ„ä¸­ä½¿ç”¨ã€‚
è«‹åœ¨å·²ç¶å®šçš„åŒç›Ÿç¾¤çµ„ä¸­ @æˆ‘ é–‹å§‹ä½¿ç”¨ï¼
```

---

## API Endpoints

### Web App (éœ€è¦ JWT èªè­‰)

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/v1/linebot/codes` | ç”Ÿæˆç¶å®šç¢¼ |
| GET | `/api/v1/linebot/binding` | æŸ¥è©¢ç¶å®šç‹€æ…‹ |
| DELETE | `/api/v1/linebot/binding` | è§£é™¤ç¶å®š |
| POST | `/api/v1/linebot/binding/refresh-info` | åˆ·æ–°ç¾¤çµ„è³‡è¨Š |

### LIFF (LINE User ID + Group ID èªè­‰)

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/v1/linebot/member/info` | æŸ¥è©¢æˆå“¡è³‡è¨Š |
| GET | `/api/v1/linebot/member/performance` | æŸ¥è©¢æˆå“¡è¡¨ç¾ |
| POST | `/api/v1/linebot/member/register` | è¨»å†ŠéŠæˆ² ID |
| DELETE | `/api/v1/linebot/member/unregister` | åˆªé™¤éŠæˆ² ID ç¶å®š |
| GET | `/api/v1/linebot/copper/list` | æŸ¥è©¢éŠ…ç¤¦åˆ—è¡¨ |
| POST | `/api/v1/linebot/copper/register` | è¨»å†ŠéŠ…ç¤¦ |
| DELETE | `/api/v1/linebot/copper/{id}` | åˆªé™¤éŠ…ç¤¦ |

### Webhook

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/v1/linebot/webhook` | LINE äº‹ä»¶è™•ç† |

---

## äº‹ä»¶è™•ç†æµç¨‹

```
äº‹ä»¶é€²å…¥
    â”‚
    â”œâ”€ Bot åŠ å…¥ç¾¤çµ„ (join)
    â”‚   â””â”€ ç™¼é€ç¶å®šèªªæ˜
    â”‚
    â”œâ”€ æ–°æˆå“¡åŠ å…¥ (memberJoined)
    â”‚   â””â”€ ç¾¤çµ„å·²ç¶å®š â†’ ç™¼é€ LIFF å…¥å£
    â”‚
    â”œâ”€ è¨Šæ¯ (message)
    â”‚   â”œâ”€ /ç¶å®š CODE â†’ åŸ·è¡Œç¶å®š
    â”‚   â”œâ”€ @bot â†’ ç™¼é€ LIFF å…¥å£
    â”‚   â””â”€ æœªè¨»å†Š & æœªé€šçŸ¥é â†’ ç™¼é€ LIFF å…¥å£
    â”‚
    â”œâ”€ åŠ å¥½å‹ (follow)
    â”‚   â””â”€ ç™¼é€ç°¡çŸ­èªªæ˜
    â”‚
    â””â”€ å…¶ä»– â†’ å¿½ç•¥
```

---

## ç§»é™¤çš„åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å·²å¾ Bot ç§»é™¤ï¼ˆæ”¹ç”± LIFF è™•ç†ï¼‰ï¼š

- âŒ `/ç‹€æ…‹` æŒ‡ä»¤
- âŒ `/å¹«åŠ©` æŒ‡ä»¤
- âŒ ç¾¤çµ„ 30 åˆ†é˜å†·å»æ©Ÿåˆ¶ï¼ˆæ”¹ç‚ºæ¯ç”¨æˆ¶ 3 åˆ†é˜ CDï¼‰
- âŒ ç§èŠè¤‡é›œè™•ç†
- âŒ å€‹äººè¡¨ç¾æŸ¥è©¢
- âŒ æ’è¡Œæ¦œ

---

## æª”æ¡ˆçµæ§‹

```
backend/src/
â”œâ”€â”€ api/v1/endpoints/
â”‚   â””â”€â”€ linebot.py              # LINE Bot endpoints
â”œâ”€â”€ models/
â”‚   â””â”€â”€ line_binding.py         # Pydantic models
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ line_binding_repository.py  # Data access
â”œâ”€â”€ services/
â”‚   â””â”€â”€ line_binding_service.py # Binding logic
â””â”€â”€ core/
    â”œâ”€â”€ config.py               # LINE Bot config
    â””â”€â”€ line_auth.py            # LINE auth utilities
```

---

## å®‰å…¨æ©Ÿåˆ¶

| æ©Ÿåˆ¶ | èªªæ˜ |
|------|------|
| Webhook ç°½åé©—è­‰ | HMAC-SHA256 |
| ç¶å®šç¢¼éæœŸ | 5 åˆ†é˜ |
| Rate Limit | 3 ç¢¼/å°æ™‚/åŒç›Ÿ |
| å®‰å…¨å­—ç¬¦é›† | å»é™¤ 0/O/I/1 |

---

*Last Updated: 2026-01-22*
